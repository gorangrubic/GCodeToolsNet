<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="css/vendor.min.css" />

    <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU"
        crossorigin="anonymous"> -->

    <title>GCodeTools</title>
    <style>
        html, body {
            margin: 0px;
            padding: 0px;
            overflow: hidden;
            height: 100%;
        }
        
        .widget-3dviewer-inspect {
            /* padding-bottom: 0; */
            /* margin-bottom: 0; */
            font-size: 10px;
            position: absolute;
            /* min-width: 250px; */
            /* max-width: 100%; */
            background-color: white;
            z-index: 9;
            box-shadow: 0 0 20px #888888;
        }

        .hidden {
            margin: 0px;
            padding: 0px;
            position: absolute;
            display: block;
            visibility: hidden;
        }
    </style>
</head>

<body>
    <div id="widget-3dviewer" class="card h-100 w-100 float-left">
        <div class="card-header">
            <div class="btn-toolbar float-left" role="toolbar">
                <div class="btn-group" role="group" data-style="padding-right:6px;">
                    <button type="button" class="btn btn-sm btn-secondary widget-3d-menu-viewextents" data-container="body"
                        data-toggle="popover" data-placement="auto" data-content="View extents of GCode object"
                        data-trigger="hover" data-delay="800"> <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary widget-3d-menu-lookattoolhead active btn-primary"
                        data-container="body" data-toggle="popover" data-placement="auto" data-content="Look at the toolhead toggle button. If toggled on, during the sample or real run of Gcode the 3D view will always place the toolhead at the center. Toggling this off means the camera will not reposition onto the toolhead during moves."
                        data-trigger="hover" data-delay="800"> <i class="fas fa-video"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary widget-3d-menu-jog" data-container="body"
                        data-toggle="popover" data-placement="auto" data-content="Jog Mode. Click here or hold down Ctrl on the keyboard while your mouse is over the 3D viewer to turn on jog mode. This lets you move around the 3D object and click to jog based on where the jog head is at."
                        data-trigger="hover" data-delay="800">Jog
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary widget-3d-menu-inspect" data-container="body"
                        data-toggle="popover" data-placement="auto" data-content="Inspect Mode. Click here or hold down Shift on the keyboard while your mouse is over the 3D viewer to turn on inspect mode. This lets you inspect lines in the 3D Viewer."
                        data-trigger="hover" data-delay="800">
                        <i class="fas fa-search"></i>
                        <i class="fas fa-hand-point-left"></i>
                    </button>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-secondary dropdown-toggle" data-toggle="dropdown">
                            <i class="fas fa-th"></i></button>
                        <div id="widget-3dviewer-gridsizing" class="dropdown-menu" role="menu">
                            <div role="presentation" class="dropdown-header">Grid Size</div>
                            <a class="dropdown-item alert-info widget-3dviewer-gridsizing-1x">1x
                                (Default)</a>
                            <a class="dropdown-item widget-3dviewer-gridsizing-2x">2x</a>
                            <a class="dropdown-item widget-3dviewer-gridsizing-5x">5x</a>
                            <a class="dropdown-item widget-3dviewer-gridsizing-10x">10x</a>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-secondary dropdown-toggle" data-toggle="dropdown">
                            <i class="fas fa-cog"></i></button>
                        <div id="widget-3dviewer-settings" class="dropdown-menu" role="menu">
                            <div role="presentation" class="dropdown-header">Options</div>
                            <a class="dropdown-item widget-3dviewer-settings-shadows">Toggle Toolhead Shadow
                                On/Off</a>
                            <div role="presentation" class="dropdown-divider"></div>
                            <div role="presentation" class="dropdown-header">Frame Rate of Rendering</div>
                            <a class="dropdown-item widget-3dviewer-settings-fr widget-3dviewer-settings-fr-5">5
                                fps (Least CPU Usage)</a>
                            <a class="dropdown-item widget-3dviewer-settings-fr widget-3dviewer-settings-fr-10">10
                                fps</a>
                            <a class="dropdown-item widget-3dviewer-settings-fr widget-3dviewer-settings-fr-15">15
                                fps</a>
                            <a class="dropdown-item alert-info widget-3dviewer-settings-fr widget-3dviewer-settings-fr-30">30
                                fps (Default)</a>
                            <a class="dropdown-item widget-3dviewer-settings-fr widget-3dviewer-settings-fr-60">60
                                fps (Most CPU Usage)</a>
                            <div role="presentation" class="dropdown-divider"></div>
                            <div role="presentation" class="dropdown-header">For Super Slow Machines</div>
                            <a class="dropdown-item widget-3dviewer-settings-fr widget-3dviewer-settings-fr-0">Disable
                                3D Viewer (No CPU Usage)</a>
                        </div>
                    </div>
                </div>
                <div class="btn-group" role="group" data-style="padding-right:6px;">
                    <div class="btn-sm widget-3dviewer-simulator-title">Simulator</div>
                    <button type="button" class="btn btn-sm btn-secondary widget-3d-menu-samplerun" data-container="body"
                        data-toggle="popover" data-placement="auto" data-content="Play a sample run of the GCode"
                        data-trigger="hover" data-delay="800"> <i class="fas fa-play"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary widget-3d-menu-samplerunspeed" data-container="body"
                        data-toggle="popover" data-placement="auto" data-content="Speed up from x1 to x1000"
                        data-trigger="hover" data-delay="800">x1</button>
                    <button type="button" class="btn btn-sm btn-secondary widget-3d-menu-samplerunpause" data-container="body"
                        data-toggle="popover" data-placement="auto" data-content="Pause the sample run of the GCode"
                        data-trigger="hover" data-delay="800"> <i class="fas fa-pause"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary widget-3d-menu-samplerunstop" data-container="body"
                        data-toggle="popover" data-placement="auto" data-content="Stop the sample run of the GCode"
                        data-trigger="hover" data-delay="800"> <i class="fas fa-stop"></i>
                    </button>
                </div>
                <div class="btn-group" role="group" style="position:relative;font-size:9px;line-height:22px;">
                    <div style="position:absolute;top:-1px;left:28px;border:0px solid red;line-height:10px;" class="widget-3dviewer-units-indicator">-</div>
                    <div style="position:absolute;top:5px;left:28px;border:0px solid red;" class="widget-3dviewer-frames-per-sec">32&nbsp;fps</div>
                </div>
            </div>
            <!-- <span class="card-title" style="padding-right:10px;" data-toggle="popover" data-trigger="hover"
                data-placement="auto" data-content="">3D&nbsp;Viewer</span>
            <div style="bottom:-18px;left:0px;border:0px solid red;line-height:10px;" class="widget-3dviewer-panzoom-indicator">Pan:
                Right-Click Drag, Zoom: Mousewheel/Touchpad Scroll, Orbit: Mouse/Touch Drag</div> -->
        </div>
        <div id="widget-3dviewer-body" class="card h-100 card-body p-0 m-0">
            <!-- WebGL rendering area -->
            <div id="widget-3dviewer-renderArea" tabindex="1" class="h-100">
                <div class="youhavenowebgl hidden" style="width:100%;height:100%;color:white;position:absolute;top:0;left:0;">
                    You appear to not have WebGL support or WebGL has crashed. The 3D Viewer can't be used without
                    WebGL.</div>
                <div class="data-details hidden">Drag and Drop Gcode Here...</div>
            </div>
            <div class="widget-3dviewer-inspect card hidden">
                <table class="table table-bordered table-striped table-sm">
                    <tbody>
                        <tr>
                            <th colspan="2" class="card-title">
                                <button type="button" class="close">&times;</button>
                            </th>
                        </tr>
                        <tr class="table-active">
                            <td>Line</td>
                            <td>
                                <span class="inspect-line"></span>
                                <button class="btn btn-secondary btn-sm float-right inspect-btn-goto">Go To</button>
                            </td>
                        </tr>
                        <tr>
                            <td>Gcode</td>
                            <td class="inspect-gcode"></td>
                        </tr>
                        <tr>
                            <td>End Pos</td>
                            <td class="inspect-end"></td>
                        </tr>
                        <tr>
                            <td>Feedrate</td>
                            <td class="inspect-feedrate"></td>
                        </tr>
                        <tr>
                            <td>Distance of Move</td>
                            <td class="inspect-distance"></td>
                        </tr>
                        <tr>
                            <td>Time for This Line</td>
                            <td class="inspect-time"></td>
                        </tr>
                        <tr>
                            <td>Est Time to Get Here</td>
                            <td class="inspect-timeSum"></td>
                        </tr>
                    </tbody>
                </table>

            </div>
            <div id="warningArea">
                <div class="alert alert-warning alert-dismissable hidden">
                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>G2/G3
                    arcs only rendered as straight lines. They are yellow to show where actual positioning in your CNC
                    will differ from 3D rendering. If anyone wants to fork and fix arcs, feel free.</div>
            </div>
        </div>
    </div>

    <script src="js/vendor.min.js"></script>

    <!-- <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script> -->

    <script src="js/three.js"></script>
    <script src="js/OrbitControls.js"></script>
    <script src="js/TrackballControls.js"></script>
    <script src="js/tween.min.js"></script>

    <!-- Custom code -->
    <script src="gcode-parser.js"></script>
    <script src="gcode-model.js"></script>
    <script src="renderer.js"></script>
    <script src="ui.js"></script>

    <script>
        var manager = new THREE.LoadingManager();
        manager.onLoad = function () { // when all resources are loaded
            init();
        }

        var font = null;
        var loader = new THREE.FontLoader(manager);
        loader.load('fonts/helvetiker_regular.typeface.json', function (response) {
            font = response;
        });

        var scene = null;
        var object = null;
        var camera = null;
        var controls = null;
        var element = null;

        var wantAnimate = true; // we automatically timeout rendering to save on cpu
        var grid = null; // stores grid

        function init() {
            var that = this;

            console.log("Doing my own drag drop for 3D viewer cuz asked to. Attaching to body tag in DOM.");
            $('body').on('dragover', function (event) {
                event.stopPropagation();
                event.preventDefault();
                event.originalEvent.dataTransfer.dropEffect = 'copy'
            }).on('drop', function (event) {
                console.log("got drop:", event);
                event.stopPropagation();
                event.preventDefault();
                var files = event.originalEvent.dataTransfer.files;
                if (files.length > 0) {
                    var reader = new FileReader();
                    reader.onload = function () {
                        console.log("opening file. reader:", reader);
                        console.log("stringify", JSON.stringify(reader.result, null, 2));
                        that.openGCodeFromText(reader.result);
                    };
                    reader.readAsText(files[0]);
                }
            });

            that.scene = that.createScene($('#widget-3dviewer-renderArea'));

            var lastImported = localStorage.getItem('last-imported');
            var lastLoaded = localStorage.getItem('last-loaded');
            if (lastImported) {
                that.openGCodeFromText(lastImported);
            } else {
                console.log("loading chilipeppr logo");
                // openGCodeFromPath(lastLoaded || 'https://www.chilipeppr.com/3d/chilipepprlogo.nc');
                // openGCodeFromPath('gcode/octocat.gcode');
                // openGCodeFromPath('gcode/part.gcode');
                that.openGCodeFromPath('gcode/dino-example.ngc');
            }

            var lastFpsRate = localStorage.getItem('fpsRate');
            if (lastFpsRate) {
                console.log("got prior FPS Rate, setting it now:  ", lastFpsRate, "//rk");
                var fr = parseInt(lastFpsRate);
                this.setFrameRate(fr);
                // set css to show selected
                $('.widget-3dviewer-settings-fr').removeClass('alert-info');
                $('.widget-3dviewer-settings-fr-' + fr).addClass('alert-info');
            }

            // setup toolbar buttons
            this.btnSetup();

            // subscribe to gotoline signal so we can move toolhead to correct location
            // to sync with the gcode sender
            // chilipeppr.subscribe('/' + this.id + '/gotoline', this, this.gotoLine);

            // subscribe to gotoline signal so we can move toolhead to correct location
            // to sync with the actual milling machine
            // chilipeppr.subscribe('/com-chilipeppr-interface-cnccontroller/axes', this, this.gotoXyz);

            // we can be asked to resize ourself by a publish call to this signal
            // chilipeppr.subscribe('/' + this.id + '/resize', this, this.resize);

            // requestUnits, recvUnits
            // chilipeppr.subscribe("/" + this.id + "/requestUnits", this, this.requestUnits);

            // setup more pubsub to allow other widgets to inject objects to our scene
            // this.setupScenePubSub();

            this.setupGridSizeMenu();

            this.setupCogMenu();
            this.setupFpsMenu();

            this.initJog();
            this.initInspect();

            // hide the pan/zoom/orbit msg after 1 minute
            setTimeout(function () {
                console.log("hiding pan/zoom/orbit msg");
                $('.widget-3dviewer-panzoom-indicator').fadeOut("slow");
            }, 60 * 1000);
        }    
    </script>
</body>

</html>